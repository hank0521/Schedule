# 專案建置指南

## 📋 目錄
- [環境需求](#環境需求)
- [本地開發環境建置](#本地開發環境建置)
- [Docker 環境建置](#docker-環境建置)
- [環境變數設定](#環境變數設定)
- [測試執行](#測試執行)

---

## 環境需求

### 本地開發
- **Python**: 3.10+
- **PostgreSQL**: 15+
- **pip**: 最新版本

### Docker 開發
- **Docker**: 20.10+
- **Docker Compose**: 2.0+

---

## 本地開發環境建置

### 1. 克隆專案
```bash
git clone <repository-url>
cd Schedule/API
```

### 2. 創建虛擬環境
```bash
# Windows
python -m venv venv
venv\Scripts\activate

# Linux/Mac
python3 -m venv venv
source venv/bin/activate
```

### 3. 安裝依賴
```bash
pip install -r requirements.txt
```

### 4. 設定環境變數
```bash
# 複製環境變數範本
cd ..
cp .env.example .env
```

編輯 `.env` 檔案，設定以下必要參數：
```env
# 資料庫設定
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_DB=SYSDATA
POSTGRES_USER=sa
POSTGRES_PASSWORD=your_password

# API 設定
APP_NAME=Schedule API
DEBUG=True
SECRET_KEY=your-secret-key
API_KEY=your-api-key

# 加密金鑰 (使用下方指令生成)
ENCRYPTION_KEY=your-encryption-key

# CORS 設定
CORS_ORIGINS=["http://localhost:3000","http://localhost:8080"]

# 日誌設定
LOG_LEVEL=INFO
LOG_FILE_MAX_BYTES=10485760
LOG_FILE_BACKUP_COUNT=5
```

### 5. 生成加密金鑰
```bash
python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"
```
將生成的金鑰複製到 `.env` 的 `ENCRYPTION_KEY`

### 6. 準備資料庫
確保 PostgreSQL 已安裝並運行：
```bash
# 建立資料庫
psql -U postgres -c "CREATE DATABASE SYSDATA;"

# 執行初始化 SQL (如果有)
psql -U sa -d SYSDATA -f ../Database/CreateTable.sql
```

### 7. 啟動 API 服務
```bash
cd API

# 方法 1: 使用 uvicorn
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# 方法 2: 使用 run.py (如果存在)
python run.py
```

### 8. 驗證服務
打開瀏覽器訪問：
- **健康檢查**: http://localhost:8000/health
- **API 文件**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc

---

## Docker 環境建置

### 1. 設定環境變數
```bash
cd Schedule
cp .env.example .env
```

編輯 `.env` 檔案（至少設定密碼和加密金鑰）：
```env
POSTGRES_PASSWORD=your_strong_password
ENCRYPTION_KEY=your-encryption-key-here
```

### 2. 生成加密金鑰（Docker 方式）
```bash
docker run --rm python:3.10-slim python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"
```

### 3. 啟動所有服務
```bash
# 啟動 PostgreSQL + API
docker-compose up -d

# 查看服務狀態
docker-compose ps

# 查看日誌
docker-compose logs -f api
```

### 4. 啟動特定服務
```bash
# 僅啟動資料庫
docker-compose up -d postgres

# 僅啟動 API
docker-compose up -d api
```

### 5. 啟動 pgAdmin（可選）
```bash
docker-compose --profile tools up -d pgadmin
```
訪問: http://localhost:5050

### 6. 驗證 Docker 部署
```bash
# 檢查服務狀態
docker-compose ps

# 測試 API 健康檢查
curl http://localhost:8000/health

# 測試資料庫連線
curl http://localhost:8000/health/db
```

預期輸出：
```json
{
  "status": "healthy",
  "timestamp": "2025-10-05T12:00:00.000000",
  "version": "1.0.0"
}
```

---

## 環境變數設定

### 完整環境變數說明

| 變數名稱 | 說明 | 預設值 | 必填 |
|---------|------|--------|------|
| `POSTGRES_HOST` | 資料庫主機 | localhost | ✅ |
| `POSTGRES_PORT` | 資料庫端口 | 5432 | ✅ |
| `POSTGRES_DB` | 資料庫名稱 | SYSDATA | ✅ |
| `POSTGRES_USER` | 資料庫使用者 | sa | ✅ |
| `POSTGRES_PASSWORD` | 資料庫密碼 | - | ✅ |
| `APP_NAME` | 應用名稱 | Schedule API | ❌ |
| `DEBUG` | 除錯模式 | False | ❌ |
| `SECRET_KEY` | API 密鑰 | - | ✅ |
| `API_KEY` | API 認證金鑰 | - | ✅ |
| `ENCRYPTION_KEY` | 加密金鑰 | - | ✅ |
| `CORS_ORIGINS` | CORS 允許來源 | ["*"] | ❌ |
| `LOG_LEVEL` | 日誌等級 | INFO | ❌ |
| `LOG_FILE_MAX_BYTES` | 日誌檔案大小上限 | 10485760 | ❌ |
| `LOG_FILE_BACKUP_COUNT` | 日誌備份數量 | 5 | ❌ |

---

## 測試執行

### 本地環境測試
```bash
# 執行所有測試
pytest tests/ -v

# 執行特定測試檔案
pytest tests/test_core/test_database.py -v

# 執行測試並生成覆蓋率報告
pytest tests/ --cov=app --cov-report=html
```

### Docker 環境測試
```bash
# 進入 API 容器執行測試
docker-compose exec api pytest tests/ -v

# 執行特定測試
docker-compose exec api pytest tests/test_core/test_database.py -v

# 查看測試覆蓋率
docker-compose exec api pytest tests/ --cov=app --cov-report=term-missing
```

---

## 常用指令

### Docker 管理
```bash
# 停止所有服務
docker-compose down

# 停止並刪除資料（危險）
docker-compose down -v

# 重新建置 API
docker-compose up -d --build api

# 查看日誌
docker-compose logs -f api
docker-compose logs -f postgres

# 進入容器
docker-compose exec api bash
docker-compose exec postgres bash

# 執行 psql
docker-compose exec postgres psql -U sa -d SYSDATA
```

### 本地開發
```bash
# 更新依賴
pip install -r requirements.txt --upgrade

# 格式化程式碼（如果有使用 black）
black app/ tests/

# 檢查程式碼風格（如果有使用 flake8）
flake8 app/ tests/

# 查看資料庫連線
python -c "from app.config import settings; print(settings.DATABASE_URL)"
```

---

## 疑難排解

### API 無法啟動
1. 檢查日誌：
   ```bash
   # Docker
   docker-compose logs api

   # 本地
   cat logs/schedule_api.log
   ```

2. 檢查環境變數是否正確設定
3. 確認資料庫是否已啟動並可連線

### 資料庫連線失敗
1. 確認 PostgreSQL 正在運行
   ```bash
   # Docker
   docker-compose ps postgres

   # 本地
   pg_isready -h localhost -p 5432
   ```

2. 檢查連線字串
   ```bash
   docker-compose exec api python -c "from app.config import settings; print(settings.DATABASE_URL)"
   ```

3. 測試手動連線
   ```bash
   psql -h localhost -U sa -d SYSDATA
   ```

### 測試失敗
1. 確認測試資料庫存在
   ```bash
   # 檢查測試資料庫
   docker-compose exec postgres psql -U sa -d postgres -c "\l"

   # 手動建立測試資料庫（如果不存在）
   docker-compose exec postgres psql -U sa -d postgres -c "CREATE DATABASE \"SYSDATA_test\""
   ```

2. 清理測試資料
   ```bash
   docker-compose exec postgres psql -U sa -d SYSDATA_test -c "DROP SCHEMA public CASCADE; CREATE SCHEMA public;"
   ```

---

## 下一步

建置完成後，請參考：
- **2.DEVELOPMENT.md** - 了解開發工具與規範
- **4.API_UPDATES.md** - 查看 API 端點文件
