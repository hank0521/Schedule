# é–‹ç™¼å·¥å…·èˆ‡è¦ç¯„

## ğŸ“‹ ç›®éŒ„
- [å°ˆæ¡ˆæ¶æ§‹](#å°ˆæ¡ˆæ¶æ§‹)
- [æ ¸å¿ƒå…±ç”¨é¡åˆ¥](#æ ¸å¿ƒå…±ç”¨é¡åˆ¥)
- [DatabaseManager ä½¿ç”¨æŒ‡å—](#databasemanager-ä½¿ç”¨æŒ‡å—)
- [é–‹ç™¼è¦ç¯„](#é–‹ç™¼è¦ç¯„)
- [æœ€ä½³å¯¦è¸](#æœ€ä½³å¯¦è¸)

---

## å°ˆæ¡ˆæ¶æ§‹

```
API/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ core/              # æ ¸å¿ƒå…±ç”¨æ¨¡çµ„
â”‚   â”‚   â”œâ”€â”€ database.py    # è³‡æ–™åº«ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ http_client.py # HTTP å®¢æˆ¶ç«¯
â”‚   â”‚   â”œâ”€â”€ ftp_client.py  # FTP å®¢æˆ¶ç«¯
â”‚   â”‚   â”œâ”€â”€ mail_client.py # Email å®¢æˆ¶ç«¯
â”‚   â”‚   â”œâ”€â”€ crypto.py      # åŠ å¯†æœå‹™
â”‚   â”‚   â””â”€â”€ logger.py      # æ—¥èªŒæœå‹™
â”‚   â”œâ”€â”€ models/            # è³‡æ–™æ¨¡å‹ (ORM)
â”‚   â”œâ”€â”€ schemas/           # Pydantic Schemas
â”‚   â”œâ”€â”€ routers/           # API è·¯ç”±
â”‚   â”œâ”€â”€ services/          # æ¥­å‹™é‚è¼¯å±¤
â”‚   â”œâ”€â”€ utils/             # å·¥å…·å‡½å¼
â”‚   â”‚   â”œâ”€â”€ validators.py  # è³‡æ–™é©—è­‰
â”‚   â”‚   â”œâ”€â”€ exceptions.py  # è‡ªè¨‚ä¾‹å¤–
â”‚   â”‚   â””â”€â”€ helpers.py     # è¼”åŠ©å‡½å¼
â”‚   â”œâ”€â”€ dependencies/      # ä¾è³´æ³¨å…¥
â”‚   â”œâ”€â”€ config.py          # é…ç½®ç®¡ç†
â”‚   â””â”€â”€ main.py            # æ‡‰ç”¨é€²å…¥é»
â”œâ”€â”€ tests/                 # æ¸¬è©¦æª”æ¡ˆ
â”œâ”€â”€ logs/                  # æ—¥èªŒç›®éŒ„
â””â”€â”€ requirements.txt       # ä¾è³´æ¸…å–®
```

---

## æ ¸å¿ƒå…±ç”¨é¡åˆ¥

### 1. DatabaseManager - è³‡æ–™åº«ç®¡ç†

**ä½ç½®**: `app/core/database.py`

**ç”¨é€”**: çµ±ä¸€ç®¡ç†æ‰€æœ‰è³‡æ–™åº«æ“ä½œ

**åŸºæœ¬ä½¿ç”¨**:
```python
from app.core.database import db_manager
from app.models.schedule_http import ScheduleHttp

# æŸ¥è©¢
task = await db_manager.get_by_id(ScheduleHttp, 1)

# æ–°å¢
new_task = ScheduleHttp(prog_code="TEST", url="https://example.com")
created = await db_manager.create(new_task)

# æ›´æ–°
task.url = "https://new-url.com"
updated = await db_manager.update(task)

# åˆªé™¤
await db_manager.delete_by_id(ScheduleHttp, 1)
```

**è©³ç´°æ–‡æª”**: è«‹åƒé–± [DatabaseManager ä½¿ç”¨æŒ‡å—](#databasemanager-ä½¿ç”¨æŒ‡å—)

---

### 2. HTTPClient - HTTP è«‹æ±‚å®¢æˆ¶ç«¯

**ä½ç½®**: `app/core/http_client.py`

**ç”¨é€”**: ç™¼é€ HTTP è«‹æ±‚ï¼Œæ”¯æ´é‡è©¦æ©Ÿåˆ¶

**ä½¿ç”¨ç¯„ä¾‹**:
```python
from app.core.http_client import HTTPClient

# å»ºç«‹å®¢æˆ¶ç«¯ï¼ˆæ”¯æ´é‡è©¦ï¼‰
client = HTTPClient(timeout=10, retry_count=3, retry_interval=1)

# GET è«‹æ±‚
response = await client.get("https://api.example.com/data")
data = response.json()

# POST è«‹æ±‚ï¼ˆå¸¶ JSONï¼‰
response = await client.post(
    "https://api.example.com/submit",
    json={"key": "value"}
)

# é©—è­‰ç‹€æ…‹ç¢¼
if client.validate_response(response, 200):
    print("æˆåŠŸ!")

# è¨˜å¾—é—œé–‰å®¢æˆ¶ç«¯
await client.close()
```

**ä¸»è¦æ–¹æ³•**:
- `get(url, **kwargs)` - GET è«‹æ±‚
- `post(url, **kwargs)` - POST è«‹æ±‚
- `put(url, **kwargs)` - PUT è«‹æ±‚
- `delete(url, **kwargs)` - DELETE è«‹æ±‚
- `validate_response(response, expected_status)` - é©—è­‰ç‹€æ…‹ç¢¼

---

### 3. FTPClient - FTP/SFTP å®¢æˆ¶ç«¯

**ä½ç½®**: `app/core/ftp_client.py`

**ç”¨é€”**: FTP æª”æ¡ˆå‚³è¼¸ï¼Œæ”¯æ´ FTP å’Œ SFTP

**ä½¿ç”¨ç¯„ä¾‹**:
```python
from app.core.ftp_client import FTPClientFactory

# å»ºç«‹ FTP å®¢æˆ¶ç«¯
ftp = FTPClientFactory.create_client(
    protocol="ftp",
    host="ftp.example.com",
    port=21,
    username="user",
    password="pass"
)

# é€£ç·š
await ftp.connect()

# ä¸Šå‚³å–®ä¸€æª”æ¡ˆ
await ftp.upload_file(
    local_path="/path/to/local/file.txt",
    remote_path="/remote/file.txt"
)

# æ‰¹æ¬¡ä¸Šå‚³ï¼ˆæ”¯æ´è¬ç”¨å­—å…ƒï¼‰
await ftp.upload_files_with_pattern(
    local_dir="/local/dir",
    pattern="*.csv",
    remote_dir="/remote/dir",
    delete_after_upload=False
)

# ä¸‹è¼‰æª”æ¡ˆ
await ftp.download_file(
    remote_path="/remote/file.txt",
    local_path="/local/file.txt"
)

# æ–·ç·š
await ftp.disconnect()
```

**æ”¯æ´å”å®š**:
- `ftp` - æ¨™æº– FTP
- `sftp` - SFTP (SSH)

---

### 4. MailClient - Email ç™¼é€å®¢æˆ¶ç«¯

**ä½ç½®**: `app/core/mail_client.py`

**ç”¨é€”**: ç™¼é€ Emailï¼Œæ”¯æ´é™„ä»¶å’Œ HTML

**ä½¿ç”¨ç¯„ä¾‹**:
```python
from app.core.mail_client import MailClient

# å»ºç«‹å®¢æˆ¶ç«¯
mail = MailClient(
    smtp_server="smtp.gmail.com",
    smtp_port=587,
    username="user@gmail.com",
    password="app_password",
    use_tls=True
)

# ç™¼é€ç´”æ–‡å­—éƒµä»¶
await mail.send_email(
    to_addresses="recipient@example.com",
    subject="æ¸¬è©¦éƒµä»¶",
    body="é€™æ˜¯ä¸€å°æ¸¬è©¦éƒµä»¶"
)

# ç™¼é€ HTML éƒµä»¶ï¼ˆå¸¶é™„ä»¶ï¼‰
await mail.send_email(
    to_addresses="recipient@example.com",
    subject="å ±è¡¨",
    body="<h1>æœˆå ±è¡¨</h1><p>è«‹æŸ¥æ”¶é™„ä»¶</p>",
    is_html=True,
    attachments=["/path/to/report.pdf"]
)

# å¤šæ”¶ä»¶è€…ï¼ˆæ”¯æ´ CC/BCCï¼‰
await mail.send_email(
    to_addresses="user1@example.com;user2@example.com",
    cc_addresses="cc@example.com",
    bcc_addresses="bcc@example.com",
    subject="é€šçŸ¥",
    body="å…§å®¹"
)

# é—œé–‰é€£ç·š
await mail.close()
```

---

### 5. CryptoService - åŠ å¯†è§£å¯†æœå‹™

**ä½ç½®**: `app/core/crypto.py`

**ç”¨é€”**: åŠ å¯†æ•æ„Ÿè³‡æ–™ï¼ˆå¦‚å¯†ç¢¼ï¼‰

**ä½¿ç”¨ç¯„ä¾‹**:
```python
from app.core.crypto import crypto_service

# åŠ å¯†
encrypted = crypto_service.encrypt("my_password")
# è¿”å›: b'gAAAAABm...'

# è§£å¯†
decrypted = crypto_service.decrypt(encrypted)
# è¿”å›: "my_password"

# ç”Ÿæˆæ–°é‡‘é‘°
new_key = crypto_service.generate_key()
```

**æ³¨æ„**: åŠ å¯†é‡‘é‘°å¿…é ˆåœ¨ `.env` ä¸­è¨­å®š `ENCRYPTION_KEY`

---

### 6. Logger - æ—¥èªŒæœå‹™

**ä½ç½®**: `app/core/logger.py`

**ç”¨é€”**: çµ±ä¸€çš„æ—¥èªŒè¨˜éŒ„

**ä½¿ç”¨ç¯„ä¾‹**:
```python
from app.core.logger import get_logger

# å–å¾— logger
logger = get_logger(__name__)

# è¨˜éŒ„ä¸åŒç­‰ç´šçš„æ—¥èªŒ
logger.debug("é™¤éŒ¯è¨Šæ¯")
logger.info("ä¸€èˆ¬è¨Šæ¯")
logger.warning("è­¦å‘Šè¨Šæ¯")
logger.error("éŒ¯èª¤è¨Šæ¯")
logger.critical("åš´é‡éŒ¯èª¤")

# è¨˜éŒ„ä¾‹å¤–
try:
    result = 1 / 0
except Exception as e:
    logger.error(f"è¨ˆç®—éŒ¯èª¤: {e}", exc_info=True)
```

**æ—¥èªŒä½ç½®**: `logs/schedule_api.log`

---

## DatabaseManager ä½¿ç”¨æŒ‡å—

### åŸºæœ¬ CRUD æ“ä½œ

#### 1. æŸ¥è©¢å–®ç­†è³‡æ–™
```python
from app.core.database import db_manager
from app.models.schedule_http import ScheduleHttp

# æ ¹æ“š ID æŸ¥è©¢
task = await db_manager.get_by_id(ScheduleHttp, 1)
if task:
    print(f"ä»»å‹™: {task.prog_code}")
```

#### 2. æŸ¥è©¢æ‰€æœ‰è³‡æ–™ï¼ˆåˆ†é ï¼‰
```python
# æŸ¥è©¢å‰ 10 ç­†
tasks = await db_manager.get_all(ScheduleHttp, skip=0, limit=10)

for task in tasks:
    print(f"{task.prog_code}: {task.url}")
```

#### 3. æ¢ä»¶æŸ¥è©¢
```python
# æŸ¥è©¢å•Ÿç”¨çš„ä»»å‹™
enabled_tasks = await db_manager.get_by_filter(
    ScheduleHttp,
    is_enabled=True,
    execution_status="Pending"
)
```

#### 4. æ–°å¢è³‡æ–™
```python
# å–®ç­†æ–°å¢
new_task = ScheduleHttp(
    prog_code="TASK_001",
    url="https://api.example.com",
    http_method="GET",
    is_enabled=True
)
created = await db_manager.create(new_task)

# æ‰¹æ¬¡æ–°å¢
tasks = [
    ScheduleHttp(prog_code="T1", url="https://api1.com"),
    ScheduleHttp(prog_code="T2", url="https://api2.com"),
]
created_tasks = await db_manager.create_many(tasks)
```

#### 5. æ›´æ–°è³‡æ–™
```python
task = await db_manager.get_by_id(ScheduleHttp, 1)
if task:
    task.url = "https://new-url.com"
    task.is_enabled = False
    updated = await db_manager.update(task)
```

#### 6. åˆªé™¤è³‡æ–™
```python
# æ ¹æ“š ID åˆªé™¤
success = await db_manager.delete_by_id(ScheduleHttp, 1)

# æ ¹æ“šå¯¦ä¾‹åˆªé™¤
task = await db_manager.get_by_id(ScheduleHttp, 1)
if task:
    await db_manager.delete(task)
```

#### 7. è¨ˆæ•¸
```python
# è¨ˆç®—æ‰€æœ‰è³‡æ–™
total = await db_manager.count(ScheduleHttp)

# æ¢ä»¶è¨ˆæ•¸
enabled_count = await db_manager.count(ScheduleHttp, is_enabled=True)
```

### é€²éšæ“ä½œ

#### åŸ·è¡ŒåŸå§‹ SQL
```python
# SELECT æŸ¥è©¢
results = await db_manager.execute_query(
    'SELECT "ProgCode", "Url" FROM tblschedulehttp WHERE "IsEnabled" = :enabled',
    {"enabled": True}
)

# è¿”å›å–®ä¸€å€¼
count = await db_manager.execute_scalar(
    "SELECT COUNT(*) FROM tblschedulehttp"
)

# INSERT/UPDATE/DELETE
rows_affected = await db_manager.execute_non_query(
    'UPDATE tblschedulehttp SET "ExecutionStatus" = :status WHERE "Id" = :id',
    {"status": "Completed", "id": 1}
)
```

#### Transaction ç®¡ç†
```python
from app.core.database import db_manager

async with db_manager.get_session() as session:
    # åœ¨åŒä¸€å€‹ transaction ä¸­åŸ·è¡Œå¤šå€‹æ“ä½œ
    task = await session.get(ScheduleHttp, 1)
    task.execute_count += 1

    # æ–°å¢æ­·å²è¨˜éŒ„
    history = ScheduleExecutionHistory(
        service_type="HTTP",
        service_task_id=task.id,
        is_success=True
    )
    session.add(history)

    # ä¸€æ¬¡æ€§æäº¤
    await session.commit()
```

---

## é–‹ç™¼è¦ç¯„

### 1. ç¨‹å¼ç¢¼é¢¨æ ¼

#### å‘½åè¦ç¯„
```python
# é¡åˆ¥åç¨±ï¼šPascalCase
class HttpTaskService:
    pass

# å‡½å¼/è®Šæ•¸ï¼šsnake_case
async def get_task_by_id(task_id: int):
    user_name = "John"

# å¸¸æ•¸ï¼šUPPER_SNAKE_CASE
MAX_RETRY_COUNT = 3
DEFAULT_TIMEOUT = 30
```

#### å‹åˆ¥æç¤º
```python
from typing import Optional, List

# âœ… å¥½çš„åšæ³•ï¼šä½¿ç”¨å‹åˆ¥æç¤º
async def get_task(task_id: int) -> Optional[ScheduleHttp]:
    return await db_manager.get_by_id(ScheduleHttp, task_id)

async def get_tasks() -> List[ScheduleHttp]:
    return await db_manager.get_all(ScheduleHttp)

# âŒ é¿å…ï¼šæ²’æœ‰å‹åˆ¥æç¤º
async def get_task(task_id):
    return await db_manager.get_by_id(ScheduleHttp, task_id)
```

### 2. åˆ†å±¤æ¶æ§‹

```
Router â†’ Service â†’ DatabaseManager â†’ Database
         â†“
      å…±ç”¨æ¨¡çµ„ (core/)
```

#### Router å±¤ï¼ˆAPI ç«¯é»ï¼‰
```python
# app/routers/schedule_http.py
from fastapi import APIRouter, HTTPException
from app.services.http_task_service import http_task_service

router = APIRouter(prefix="/api/http", tags=["HTTPä»»å‹™"])

@router.get("/{task_id}")
async def get_http_task(task_id: int):
    """å–å¾— HTTP ä»»å‹™"""
    task = await http_task_service.get_task_by_id(task_id)
    if not task:
        raise HTTPException(status_code=404, detail="ä»»å‹™ä¸å­˜åœ¨")
    return task
```

#### Service å±¤ï¼ˆæ¥­å‹™é‚è¼¯ï¼‰
```python
# app/services/http_task_service.py
from app.core.database import db_manager
from app.models.schedule_http import ScheduleHttp
from typing import Optional

class HttpTaskService:
    """HTTP ä»»å‹™æœå‹™"""

    async def get_task_by_id(self, task_id: int) -> Optional[ScheduleHttp]:
        """æ ¹æ“š ID å–å¾—ä»»å‹™"""
        return await db_manager.get_by_id(ScheduleHttp, task_id)

    async def create_task(self, task_data: dict) -> ScheduleHttp:
        """å»ºç«‹æ–°ä»»å‹™"""
        task = ScheduleHttp(**task_data)
        return await db_manager.create(task)

# å…¨åŸŸå¯¦ä¾‹
http_task_service = HttpTaskService()
```

### 3. éŒ¯èª¤è™•ç†

```python
from app.core.logger import get_logger
from app.utils.exceptions import DatabaseError, ValidationError
from fastapi import HTTPException

logger = get_logger(__name__)

# âœ… å¥½çš„åšæ³•
async def get_task(task_id: int):
    try:
        task = await db_manager.get_by_id(ScheduleHttp, task_id)
        if not task:
            raise HTTPException(status_code=404, detail="ä»»å‹™ä¸å­˜åœ¨")
        return task
    except DatabaseError as e:
        logger.error(f"è³‡æ–™åº«éŒ¯èª¤: {e}")
        raise HTTPException(status_code=500, detail="è³‡æ–™åº«éŒ¯èª¤")
    except Exception as e:
        logger.error(f"æœªé æœŸçš„éŒ¯èª¤: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail="å…§éƒ¨ä¼ºæœå™¨éŒ¯èª¤")
```

### 4. æ—¥èªŒè¨˜éŒ„

```python
from app.core.logger import get_logger

logger = get_logger(__name__)

# âœ… å¥½çš„åšæ³•ï¼šé©ç•¶çš„æ—¥èªŒç­‰ç´š
logger.debug(f"é–‹å§‹è™•ç†ä»»å‹™ ID: {task_id}")  # é™¤éŒ¯è¨Šæ¯
logger.info(f"æˆåŠŸå»ºç«‹ä»»å‹™: {task.prog_code}")  # ä¸€èˆ¬è¨Šæ¯
logger.warning(f"ä»»å‹™ {task_id} å·²åœç”¨")  # è­¦å‘Š
logger.error(f"åŸ·è¡Œä»»å‹™ {task_id} å¤±æ•—: {error}")  # éŒ¯èª¤

# è¨˜éŒ„ä¾‹å¤–å †ç–Š
try:
    await execute_task(task_id)
except Exception as e:
    logger.error(f"åŸ·è¡Œå¤±æ•—: {e}", exc_info=True)
```

---

## æœ€ä½³å¯¦è¸

### 1. ä½¿ç”¨ async/await
```python
# âœ… å¥½çš„åšæ³•
async def process_tasks():
    tasks = await db_manager.get_all(ScheduleHttp)
    for task in tasks:
        await execute_task(task)

# âŒ é¿å…ï¼šæ··ç”¨åŒæ­¥ç¨‹å¼ç¢¼
def process_tasks():  # ä¸è¦ç”¨ defï¼Œè¦ç”¨ async def
    tasks = db_manager.get_all(ScheduleHttp)  # ç¼ºå°‘ await
```

### 2. è³‡æºç®¡ç†
```python
# âœ… å¥½çš„åšæ³•ï¼šä½¿ç”¨ context manager
async def send_request():
    client = HTTPClient()
    try:
        response = await client.get("https://api.example.com")
        return response
    finally:
        await client.close()

# æ›´å¥½çš„åšæ³•ï¼šä½¿ç”¨ async withï¼ˆå¦‚æœæ”¯æ´ï¼‰
async with HTTPClient() as client:
    response = await client.get("https://api.example.com")
```

### 3. ç’°å¢ƒè®Šæ•¸ä½¿ç”¨
```python
from app.config import settings

# âœ… å¥½çš„åšæ³•ï¼šå¾ settings è®€å–
database_url = settings.DATABASE_URL
debug_mode = settings.DEBUG

# âŒ é¿å…ï¼šç¡¬ç·¨ç¢¼
database_url = "postgresql://sa:password@localhost/SYSDATA"
```

### 4. è³‡æ–™é©—è­‰
```python
from app.utils.validators import validate_email, validate_url

# âœ… å¥½çš„åšæ³•ï¼šé©—è­‰è¼¸å…¥
if not validate_email(email):
    raise ValidationError("Email æ ¼å¼ä¸æ­£ç¢º")

if not validate_url(url):
    raise ValidationError("URL æ ¼å¼ä¸æ­£ç¢º")
```

### 5. æ¸¬è©¦ç·¨å¯«
```python
import pytest
from app.core.database import db_manager
from app.models.schedule_http import ScheduleHttp

@pytest.mark.asyncio
async def test_create_task():
    # å»ºç«‹æ¸¬è©¦è³‡æ–™
    task = ScheduleHttp(
        prog_code="TEST_001",
        url="https://test.com",
        http_method="GET"
    )

    # åŸ·è¡Œæ“ä½œ
    created = await db_manager.create(task)

    # é©—è­‰çµæœ
    assert created.id is not None
    assert created.prog_code == "TEST_001"

    # æ¸…ç†
    await db_manager.delete_by_id(ScheduleHttp, created.id)
```

---

## å¸¸ç”¨å·¥å…·å‡½å¼

### è³‡æ–™é©—è­‰ï¼ˆvalidators.pyï¼‰
```python
from app.utils.validators import (
    validate_cron,
    validate_email,
    validate_url,
    validate_http_method
)

# Cron è¡¨é”å¼é©—è­‰
is_valid = validate_cron("0 0 * * *")

# Email é©—è­‰
is_valid = validate_email("user@example.com")

# URL é©—è­‰
is_valid = validate_url("https://api.example.com")

# HTTP æ–¹æ³•é©—è­‰
is_valid = validate_http_method("GET")
```

### è¼”åŠ©å‡½å¼ï¼ˆhelpers.pyï¼‰
```python
from app.utils.helpers import (
    parse_datetime,
    format_datetime,
    split_by_delimiter,
    format_file_size
)

# æ—¥æœŸæ™‚é–“è§£æ
dt = parse_datetime("2025-10-05 12:00:00")

# æ—¥æœŸæ™‚é–“æ ¼å¼åŒ–
formatted = format_datetime(datetime.now(), "%Y-%m-%d")

# å­—ä¸²åˆ†å‰²ï¼ˆè™•ç†åˆ†è™Ÿ/é€—è™Ÿï¼‰
emails = split_by_delimiter("user1@test.com;user2@test.com")

# æª”æ¡ˆå¤§å°æ ¼å¼åŒ–
size = format_file_size(1048576)  # "1.00 MB"
```

---

## ä¸‹ä¸€æ­¥

é–‹ç™¼å®Œæˆå¾Œï¼Œè«‹åƒè€ƒï¼š
- **3.CHANGELOG.md** - è¨˜éŒ„è®Šæ›´
- **4.API_UPDATES.md** - æ›´æ–° API æ–‡ä»¶
