# 開發工具與規範

## 📋 目錄
- [專案架構](#專案架構)
- [核心共用類別](#核心共用類別)
- [DatabaseManager 使用指南](#databasemanager-使用指南)
- [開發規範](#開發規範)
- [最佳實踐](#最佳實踐)

---

## 專案架構

```
API/
├── app/
│   ├── core/              # 核心共用模組
│   │   ├── database.py    # 資料庫管理
│   │   ├── http_client.py # HTTP 客戶端
│   │   ├── ftp_client.py  # FTP 客戶端
│   │   ├── mail_client.py # Email 客戶端
│   │   ├── crypto.py      # 加密服務
│   │   └── logger.py      # 日誌服務
│   ├── models/            # 資料模型 (ORM)
│   ├── schemas/           # Pydantic Schemas
│   ├── routers/           # API 路由
│   ├── services/          # 業務邏輯層
│   ├── utils/             # 工具函式
│   │   ├── validators.py  # 資料驗證
│   │   ├── exceptions.py  # 自訂例外
│   │   └── helpers.py     # 輔助函式
│   ├── dependencies/      # 依賴注入
│   ├── config.py          # 配置管理
│   └── main.py            # 應用進入點
├── tests/                 # 測試檔案
├── logs/                  # 日誌目錄
└── requirements.txt       # 依賴清單
```

---

## 核心共用類別

### 1. DatabaseManager - 資料庫管理

**位置**: `app/core/database.py`

**用途**: 統一管理所有資料庫操作

**基本使用**:
```python
from app.core.database import db_manager
from app.models.schedule_http import ScheduleHttp

# 查詢
task = await db_manager.get_by_id(ScheduleHttp, 1)

# 新增
new_task = ScheduleHttp(prog_code="TEST", url="https://example.com")
created = await db_manager.create(new_task)

# 更新
task.url = "https://new-url.com"
updated = await db_manager.update(task)

# 刪除
await db_manager.delete_by_id(ScheduleHttp, 1)
```

**詳細文檔**: 請參閱 [DatabaseManager 使用指南](#databasemanager-使用指南)

---

### 2. HTTPClient - HTTP 請求客戶端

**位置**: `app/core/http_client.py`

**用途**: 發送 HTTP 請求，支援重試機制

**使用範例**:
```python
from app.core.http_client import HTTPClient

# 建立客戶端（支援重試）
client = HTTPClient(timeout=10, retry_count=3, retry_interval=1)

# GET 請求
response = await client.get("https://api.example.com/data")
data = response.json()

# POST 請求（帶 JSON）
response = await client.post(
    "https://api.example.com/submit",
    json={"key": "value"}
)

# 驗證狀態碼
if client.validate_response(response, 200):
    print("成功!")

# 記得關閉客戶端
await client.close()
```

**主要方法**:
- `get(url, **kwargs)` - GET 請求
- `post(url, **kwargs)` - POST 請求
- `put(url, **kwargs)` - PUT 請求
- `delete(url, **kwargs)` - DELETE 請求
- `validate_response(response, expected_status)` - 驗證狀態碼

---

### 3. FTPClient - FTP/SFTP 客戶端

**位置**: `app/core/ftp_client.py`

**用途**: FTP 檔案傳輸，支援 FTP 和 SFTP

**使用範例**:
```python
from app.core.ftp_client import FTPClientFactory

# 建立 FTP 客戶端
ftp = FTPClientFactory.create_client(
    protocol="ftp",
    host="ftp.example.com",
    port=21,
    username="user",
    password="pass"
)

# 連線
await ftp.connect()

# 上傳單一檔案
await ftp.upload_file(
    local_path="/path/to/local/file.txt",
    remote_path="/remote/file.txt"
)

# 批次上傳（支援萬用字元）
await ftp.upload_files_with_pattern(
    local_dir="/local/dir",
    pattern="*.csv",
    remote_dir="/remote/dir",
    delete_after_upload=False
)

# 下載檔案
await ftp.download_file(
    remote_path="/remote/file.txt",
    local_path="/local/file.txt"
)

# 斷線
await ftp.disconnect()
```

**支援協定**:
- `ftp` - 標準 FTP
- `sftp` - SFTP (SSH)

---

### 4. MailClient - Email 發送客戶端

**位置**: `app/core/mail_client.py`

**用途**: 發送 Email，支援附件和 HTML

**使用範例**:
```python
from app.core.mail_client import MailClient

# 建立客戶端
mail = MailClient(
    smtp_server="smtp.gmail.com",
    smtp_port=587,
    username="user@gmail.com",
    password="app_password",
    use_tls=True
)

# 發送純文字郵件
await mail.send_email(
    to_addresses="recipient@example.com",
    subject="測試郵件",
    body="這是一封測試郵件"
)

# 發送 HTML 郵件（帶附件）
await mail.send_email(
    to_addresses="recipient@example.com",
    subject="報表",
    body="<h1>月報表</h1><p>請查收附件</p>",
    is_html=True,
    attachments=["/path/to/report.pdf"]
)

# 多收件者（支援 CC/BCC）
await mail.send_email(
    to_addresses="user1@example.com;user2@example.com",
    cc_addresses="cc@example.com",
    bcc_addresses="bcc@example.com",
    subject="通知",
    body="內容"
)

# 關閉連線
await mail.close()
```

---

### 5. CryptoService - 加密解密服務

**位置**: `app/core/crypto.py`

**用途**: 加密敏感資料（如密碼）

**使用範例**:
```python
from app.core.crypto import crypto_service

# 加密
encrypted = crypto_service.encrypt("my_password")
# 返回: b'gAAAAABm...'

# 解密
decrypted = crypto_service.decrypt(encrypted)
# 返回: "my_password"

# 生成新金鑰
new_key = crypto_service.generate_key()
```

**注意**: 加密金鑰必須在 `.env` 中設定 `ENCRYPTION_KEY`

---

### 6. Logger - 日誌服務

**位置**: `app/core/logger.py`

**用途**: 統一的日誌記錄

**使用範例**:
```python
from app.core.logger import get_logger

# 取得 logger
logger = get_logger(__name__)

# 記錄不同等級的日誌
logger.debug("除錯訊息")
logger.info("一般訊息")
logger.warning("警告訊息")
logger.error("錯誤訊息")
logger.critical("嚴重錯誤")

# 記錄例外
try:
    result = 1 / 0
except Exception as e:
    logger.error(f"計算錯誤: {e}", exc_info=True)
```

**日誌位置**: `logs/schedule_api.log`

---

## DatabaseManager 使用指南

### 基本 CRUD 操作

#### 1. 查詢單筆資料
```python
from app.core.database import db_manager
from app.models.schedule_http import ScheduleHttp

# 根據 ID 查詢
task = await db_manager.get_by_id(ScheduleHttp, 1)
if task:
    print(f"任務: {task.prog_code}")
```

#### 2. 查詢所有資料（分頁）
```python
# 查詢前 10 筆
tasks = await db_manager.get_all(ScheduleHttp, skip=0, limit=10)

for task in tasks:
    print(f"{task.prog_code}: {task.url}")
```

#### 3. 條件查詢
```python
# 查詢啟用的任務
enabled_tasks = await db_manager.get_by_filter(
    ScheduleHttp,
    is_enabled=True,
    execution_status="Pending"
)
```

#### 4. 新增資料
```python
# 單筆新增
new_task = ScheduleHttp(
    prog_code="TASK_001",
    url="https://api.example.com",
    http_method="GET",
    is_enabled=True
)
created = await db_manager.create(new_task)

# 批次新增
tasks = [
    ScheduleHttp(prog_code="T1", url="https://api1.com"),
    ScheduleHttp(prog_code="T2", url="https://api2.com"),
]
created_tasks = await db_manager.create_many(tasks)
```

#### 5. 更新資料
```python
task = await db_manager.get_by_id(ScheduleHttp, 1)
if task:
    task.url = "https://new-url.com"
    task.is_enabled = False
    updated = await db_manager.update(task)
```

#### 6. 刪除資料
```python
# 根據 ID 刪除
success = await db_manager.delete_by_id(ScheduleHttp, 1)

# 根據實例刪除
task = await db_manager.get_by_id(ScheduleHttp, 1)
if task:
    await db_manager.delete(task)
```

#### 7. 計數
```python
# 計算所有資料
total = await db_manager.count(ScheduleHttp)

# 條件計數
enabled_count = await db_manager.count(ScheduleHttp, is_enabled=True)
```

### 進階操作

#### 執行原始 SQL
```python
# SELECT 查詢
results = await db_manager.execute_query(
    'SELECT "ProgCode", "Url" FROM tblschedulehttp WHERE "IsEnabled" = :enabled',
    {"enabled": True}
)

# 返回單一值
count = await db_manager.execute_scalar(
    "SELECT COUNT(*) FROM tblschedulehttp"
)

# INSERT/UPDATE/DELETE
rows_affected = await db_manager.execute_non_query(
    'UPDATE tblschedulehttp SET "ExecutionStatus" = :status WHERE "Id" = :id',
    {"status": "Completed", "id": 1}
)
```

#### Transaction 管理
```python
from app.core.database import db_manager

async with db_manager.get_session() as session:
    # 在同一個 transaction 中執行多個操作
    task = await session.get(ScheduleHttp, 1)
    task.execute_count += 1

    # 新增歷史記錄
    history = ScheduleExecutionHistory(
        service_type="HTTP",
        service_task_id=task.id,
        is_success=True
    )
    session.add(history)

    # 一次性提交
    await session.commit()
```

---

## 開發規範

### 1. 程式碼風格

#### 命名規範
```python
# 類別名稱：PascalCase
class HttpTaskService:
    pass

# 函式/變數：snake_case
async def get_task_by_id(task_id: int):
    user_name = "John"

# 常數：UPPER_SNAKE_CASE
MAX_RETRY_COUNT = 3
DEFAULT_TIMEOUT = 30
```

#### 型別提示
```python
from typing import Optional, List

# ✅ 好的做法：使用型別提示
async def get_task(task_id: int) -> Optional[ScheduleHttp]:
    return await db_manager.get_by_id(ScheduleHttp, task_id)

async def get_tasks() -> List[ScheduleHttp]:
    return await db_manager.get_all(ScheduleHttp)

# ❌ 避免：沒有型別提示
async def get_task(task_id):
    return await db_manager.get_by_id(ScheduleHttp, task_id)
```

### 2. 分層架構

```
Router → Service → DatabaseManager → Database
         ↓
      共用模組 (core/)
```

#### Router 層（API 端點）
```python
# app/routers/schedule_http.py
from fastapi import APIRouter, HTTPException
from app.services.http_task_service import http_task_service

router = APIRouter(prefix="/api/http", tags=["HTTP任務"])

@router.get("/{task_id}")
async def get_http_task(task_id: int):
    """取得 HTTP 任務"""
    task = await http_task_service.get_task_by_id(task_id)
    if not task:
        raise HTTPException(status_code=404, detail="任務不存在")
    return task
```

#### Service 層（業務邏輯）
```python
# app/services/http_task_service.py
from app.core.database import db_manager
from app.models.schedule_http import ScheduleHttp
from typing import Optional

class HttpTaskService:
    """HTTP 任務服務"""

    async def get_task_by_id(self, task_id: int) -> Optional[ScheduleHttp]:
        """根據 ID 取得任務"""
        return await db_manager.get_by_id(ScheduleHttp, task_id)

    async def create_task(self, task_data: dict) -> ScheduleHttp:
        """建立新任務"""
        task = ScheduleHttp(**task_data)
        return await db_manager.create(task)

# 全域實例
http_task_service = HttpTaskService()
```

### 3. 錯誤處理

```python
from app.core.logger import get_logger
from app.utils.exceptions import DatabaseError, ValidationError
from fastapi import HTTPException

logger = get_logger(__name__)

# ✅ 好的做法
async def get_task(task_id: int):
    try:
        task = await db_manager.get_by_id(ScheduleHttp, task_id)
        if not task:
            raise HTTPException(status_code=404, detail="任務不存在")
        return task
    except DatabaseError as e:
        logger.error(f"資料庫錯誤: {e}")
        raise HTTPException(status_code=500, detail="資料庫錯誤")
    except Exception as e:
        logger.error(f"未預期的錯誤: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail="內部伺服器錯誤")
```

### 4. 日誌記錄

```python
from app.core.logger import get_logger

logger = get_logger(__name__)

# ✅ 好的做法：適當的日誌等級
logger.debug(f"開始處理任務 ID: {task_id}")  # 除錯訊息
logger.info(f"成功建立任務: {task.prog_code}")  # 一般訊息
logger.warning(f"任務 {task_id} 已停用")  # 警告
logger.error(f"執行任務 {task_id} 失敗: {error}")  # 錯誤

# 記錄例外堆疊
try:
    await execute_task(task_id)
except Exception as e:
    logger.error(f"執行失敗: {e}", exc_info=True)
```

---

## 最佳實踐

### 1. 使用 async/await
```python
# ✅ 好的做法
async def process_tasks():
    tasks = await db_manager.get_all(ScheduleHttp)
    for task in tasks:
        await execute_task(task)

# ❌ 避免：混用同步程式碼
def process_tasks():  # 不要用 def，要用 async def
    tasks = db_manager.get_all(ScheduleHttp)  # 缺少 await
```

### 2. 資源管理
```python
# ✅ 好的做法：使用 context manager
async def send_request():
    client = HTTPClient()
    try:
        response = await client.get("https://api.example.com")
        return response
    finally:
        await client.close()

# 更好的做法：使用 async with（如果支援）
async with HTTPClient() as client:
    response = await client.get("https://api.example.com")
```

### 3. 環境變數使用
```python
from app.config import settings

# ✅ 好的做法：從 settings 讀取
database_url = settings.DATABASE_URL
debug_mode = settings.DEBUG

# ❌ 避免：硬編碼
database_url = "postgresql://sa:password@localhost/SYSDATA"
```

### 4. 資料驗證
```python
from app.utils.validators import validate_email, validate_url

# ✅ 好的做法：驗證輸入
if not validate_email(email):
    raise ValidationError("Email 格式不正確")

if not validate_url(url):
    raise ValidationError("URL 格式不正確")
```

### 5. 測試編寫
```python
import pytest
from app.core.database import db_manager
from app.models.schedule_http import ScheduleHttp

@pytest.mark.asyncio
async def test_create_task():
    # 建立測試資料
    task = ScheduleHttp(
        prog_code="TEST_001",
        url="https://test.com",
        http_method="GET"
    )

    # 執行操作
    created = await db_manager.create(task)

    # 驗證結果
    assert created.id is not None
    assert created.prog_code == "TEST_001"

    # 清理
    await db_manager.delete_by_id(ScheduleHttp, created.id)
```

---

## 常用工具函式

### 資料驗證（validators.py）
```python
from app.utils.validators import (
    validate_cron,
    validate_email,
    validate_url,
    validate_http_method
)

# Cron 表達式驗證
is_valid = validate_cron("0 0 * * *")

# Email 驗證
is_valid = validate_email("user@example.com")

# URL 驗證
is_valid = validate_url("https://api.example.com")

# HTTP 方法驗證
is_valid = validate_http_method("GET")
```

### 輔助函式（helpers.py）
```python
from app.utils.helpers import (
    parse_datetime,
    format_datetime,
    split_by_delimiter,
    format_file_size
)

# 日期時間解析
dt = parse_datetime("2025-10-05 12:00:00")

# 日期時間格式化
formatted = format_datetime(datetime.now(), "%Y-%m-%d")

# 字串分割（處理分號/逗號）
emails = split_by_delimiter("user1@test.com;user2@test.com")

# 檔案大小格式化
size = format_file_size(1048576)  # "1.00 MB"
```

---

## 下一步

開發完成後，請參考：
- **3.CHANGELOG.md** - 記錄變更
- **4.API_UPDATES.md** - 更新 API 文件
