# API 文件

## 📋 目錄
- [API 基本資訊](#api-基本資訊)
- [健康檢查 API](#健康檢查-api)
- [即將推出的 API](#即將推出的-api)
- [API 規範](#api-規範)

---

## API 基本資訊

### Base URL
```
開發環境: http://localhost:8000
生產環境: https://your-domain.com
```

### API 文件
- **Swagger UI**: `/docs`
- **ReDoc**: `/redoc`

### 認證方式
```
目前未啟用認證
未來將使用 API Key 認證（Header: X-API-Key）
```

### 回應格式
所有 API 回應均為 JSON 格式

#### 成功回應
```json
{
  "status": "success",
  "data": { ... },
  "message": "操作成功"
}
```

#### 錯誤回應
```json
{
  "status": "error",
  "error_code": "ERROR_CODE",
  "message": "錯誤訊息",
  "details": { ... }
}
```

---

## 健康檢查 API

### 1. API 健康檢查

檢查 API 服務是否正常運行。

**端點**: `GET /health`

**請求範例**:
```bash
curl http://localhost:8000/health
```

**回應範例**:
```json
{
  "status": "healthy",
  "timestamp": "2025-10-05T12:00:00.000000",
  "version": "1.0.0"
}
```

**狀態碼**:
- `200 OK` - 服務正常

---

### 2. 資料庫健康檢查

檢查資料庫連線是否正常。

**端點**: `GET /health/db`

**請求範例**:
```bash
curl http://localhost:8000/health/db
```

**回應範例**（成功）:
```json
{
  "database_connected": true,
  "message": "Database connection is healthy"
}
```

**回應範例**（失敗）:
```json
{
  "database_connected": false,
  "message": "Database connection failed: <error details>"
}
```

**狀態碼**:
- `200 OK` - 資料庫連線正常
- `503 Service Unavailable` - 資料庫連線失敗

---

## 即將推出的 API

以下 API 端點將在後續版本中實作：

### HTTP 排程任務 API

#### 1. 取得所有 HTTP 任務
```
GET /api/http/tasks
Query Parameters:
  - skip: int (預設: 0)
  - limit: int (預設: 100)
  - is_enabled: bool (選填)
  - execution_status: string (選填)
```

#### 2. 取得單一 HTTP 任務
```
GET /api/http/tasks/{task_id}
```

#### 3. 建立 HTTP 任務
```
POST /api/http/tasks
Body: {
  "prog_code": "string",
  "url": "string",
  "http_method": "GET|POST|PUT|DELETE",
  "cron_expression": "string",
  "is_enabled": true
}
```

#### 4. 更新 HTTP 任務
```
PUT /api/http/tasks/{task_id}
Body: { ... }
```

#### 5. 刪除 HTTP 任務
```
DELETE /api/http/tasks/{task_id}
```

---

### Mail 排程任務 API

#### 1. 取得所有 Mail 任務
```
GET /api/mail/tasks
```

#### 2. 取得單一 Mail 任務
```
GET /api/mail/tasks/{task_id}
```

#### 3. 建立 Mail 任務
```
POST /api/mail/tasks
Body: {
  "prog_code": "string",
  "smtp_server": "string",
  "smtp_port": 587,
  "to_addresses": "string",
  "subject": "string",
  "cron_expression": "string"
}
```

#### 4. 更新 Mail 任務
```
PUT /api/mail/tasks/{task_id}
```

#### 5. 刪除 Mail 任務
```
DELETE /api/mail/tasks/{task_id}
```

---

### FTP 排程任務 API

#### 1. 取得所有 FTP 任務
```
GET /api/ftp/tasks
```

#### 2. 取得單一 FTP 任務
```
GET /api/ftp/tasks/{task_id}
```

#### 3. 建立 FTP 任務
```
POST /api/ftp/tasks
Body: {
  "prog_code": "string",
  "ftp_host": "string",
  "ftp_port": 21,
  "ftp_protocol": "ftp|sftp",
  "cron_expression": "string"
}
```

#### 4. 更新 FTP 任務
```
PUT /api/ftp/tasks/{task_id}
```

#### 5. 刪除 FTP 任務
```
DELETE /api/ftp/tasks/{task_id}
```

---

### 例外記錄 API

#### 1. 查詢例外記錄
```
GET /api/exceptions
Query Parameters:
  - service_type: HTTP|Mail|FTP (選填)
  - start_date: date (選填)
  - end_date: date (選填)
  - skip: int
  - limit: int
```

#### 2. 取得單一例外記錄
```
GET /api/exceptions/{exception_id}
```

---

### 執行歷史 API

#### 1. 查詢執行歷史
```
GET /api/history
Query Parameters:
  - service_type: HTTP|Mail|FTP (選填)
  - service_task_id: int (選填)
  - is_success: bool (選填)
  - start_date: date (選填)
  - end_date: date (選填)
  - skip: int
  - limit: int
```

#### 2. 取得任務執行統計
```
GET /api/history/statistics
Query Parameters:
  - service_type: HTTP|Mail|FTP
  - start_date: date
  - end_date: date
```

---

## API 規範

### 命名規範

- 端點使用小寫，單字間用 `-` 分隔
- 資源使用複數形式：`/tasks` 而非 `/task`
- 路徑參數使用 snake_case：`/tasks/{task_id}`

### HTTP 方法

| 方法 | 用途 | 範例 |
|------|------|------|
| GET | 查詢資源 | `GET /tasks` |
| POST | 建立資源 | `POST /tasks` |
| PUT | 完整更新資源 | `PUT /tasks/1` |
| PATCH | 部分更新資源 | `PATCH /tasks/1` |
| DELETE | 刪除資源 | `DELETE /tasks/1` |

### 狀態碼

| 狀態碼 | 說明 | 使用時機 |
|--------|------|----------|
| 200 OK | 成功 | GET/PUT/PATCH 成功 |
| 201 Created | 已建立 | POST 成功建立資源 |
| 204 No Content | 無內容 | DELETE 成功 |
| 400 Bad Request | 請求錯誤 | 參數驗證失敗 |
| 401 Unauthorized | 未授權 | 缺少認證 |
| 403 Forbidden | 禁止存取 | 權限不足 |
| 404 Not Found | 找不到資源 | 資源不存在 |
| 500 Internal Server Error | 伺服器錯誤 | 內部錯誤 |
| 503 Service Unavailable | 服務不可用 | 資料庫連線失敗 |

### 分頁

所有列表 API 支援分頁：

**Query Parameters**:
- `skip`: 跳過筆數（預設: 0）
- `limit`: 限制筆數（預設: 100, 最大: 1000）

**回應格式**:
```json
{
  "total": 150,
  "skip": 0,
  "limit": 100,
  "data": [ ... ]
}
```

### 過濾與排序

**過濾**:
```
GET /api/http/tasks?is_enabled=true&execution_status=Pending
```

**排序**:
```
GET /api/http/tasks?sort=created_date&order=desc
```

### 日期時間格式

所有日期時間使用 ISO 8601 格式：
```
2025-10-05T12:00:00.000000
```

### 錯誤碼

| 錯誤碼 | 說明 |
|--------|------|
| `VALIDATION_ERROR` | 資料驗證失敗 |
| `DATABASE_ERROR` | 資料庫錯誤 |
| `NOT_FOUND` | 資源不存在 |
| `DUPLICATE_ENTRY` | 資料重複 |
| `AUTHENTICATION_ERROR` | 認證失敗 |
| `AUTHORIZATION_ERROR` | 授權失敗 |
| `INTERNAL_ERROR` | 內部錯誤 |

---

## 範例

### 建立 HTTP 任務（即將推出）

**請求**:
```bash
curl -X POST http://localhost:8000/api/http/tasks \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your-api-key" \
  -d '{
    "prog_code": "DAILY_REPORT",
    "url": "https://api.example.com/report",
    "http_method": "GET",
    "cron_expression": "0 9 * * *",
    "is_enabled": true,
    "description": "每日早上9點取得報表"
  }'
```

**回應**:
```json
{
  "status": "success",
  "data": {
    "id": 1,
    "prog_code": "DAILY_REPORT",
    "url": "https://api.example.com/report",
    "http_method": "GET",
    "cron_expression": "0 9 * * *",
    "is_enabled": true,
    "description": "每日早上9點取得報表",
    "execution_status": "Pending",
    "created_date": "2025-10-05T12:00:00.000000",
    "updated_date": "2025-10-05T12:00:00.000000"
  },
  "message": "任務建立成功"
}
```

---

### 查詢任務列表（即將推出）

**請求**:
```bash
curl "http://localhost:8000/api/http/tasks?skip=0&limit=10&is_enabled=true" \
  -H "X-API-Key: your-api-key"
```

**回應**:
```json
{
  "total": 5,
  "skip": 0,
  "limit": 10,
  "data": [
    {
      "id": 1,
      "prog_code": "DAILY_REPORT",
      "url": "https://api.example.com/report",
      "http_method": "GET",
      "is_enabled": true,
      "execution_status": "Pending",
      "created_date": "2025-10-05T12:00:00.000000"
    },
    {
      "id": 2,
      "prog_code": "HOURLY_SYNC",
      "url": "https://api.example.com/sync",
      "http_method": "POST",
      "is_enabled": true,
      "execution_status": "Completed",
      "created_date": "2025-10-05T11:00:00.000000"
    }
  ]
}
```

---

## 更新紀錄

### 2025-10-05
- ✅ 建立 API 文件架構
- ✅ 實作健康檢查 API
- 📝 規劃 HTTP/Mail/FTP 任務 API

### 未來更新
- 🚧 實作 HTTP 任務 CRUD API
- 🚧 實作 Mail 任務 CRUD API
- 🚧 實作 FTP 任務 CRUD API
- 🚧 實作例外記錄 API
- 🚧 實作執行歷史 API
- 🚧 新增 API 認證機制

---

**提示**:
- 完整的互動式 API 文件請訪問 `/docs`（Swagger UI）
- API 有變更時請同步更新 `3.CHANGELOG.md`
